@model List<RecommendedParking>

@{
    ViewData["Title"] = "Akıllı Otopark Önerisi";
}

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container-fluid mt-3">
    <div class="row">

        <!-- SOL PANEL -->
        <div class="col-md-3 border-end">
            <h5>Önerilen Otoparklar</h5>
            <div id="recommendationList">
                <small class="text-muted">
                    Haritadan bir nokta seçiniz
                </small>
            </div>
        </div>

        <!-- HARİTA -->
        <div class="col-md-9">
            <div id="map" style="height: 90vh;"></div>
        </div>

    </div>
</div>

@section Scripts {
<script>

    // ================================
    // 1️⃣ HARİTA OLUŞTUR (Lizbon merkez)
    // ================================
    const map = L.map('map').setView([38.7223, -9.1393], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // ================================
    // 2️⃣ TÜM OTOPARKLARI HARİTAYA EKLE
    // ================================
    const allParkings = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

    const baseMarkers = [];
    let recommendationMarkers = [];

    allParkings.forEach(p => {
        const marker = L.circleMarker([p.latitude, p.longitude], {
            radius: 6,
            color: '#999',
            fillOpacity: 0.6
        }).addTo(map);

        baseMarkers.push(marker);
    });

    // ================================
    // 3️⃣ HARİTAYA TIKLANINCA API ÇAĞIR
    // ================================
    map.on('click', function (e) {
        sendRecommendation(e.latlng.lat, e.latlng.lng);
    });

    // ================================
    // 4️⃣ API POST
    // ================================
    async function sendRecommendation(targetLat, targetLon) {

        const response = await fetch('/Oneri/GetRecommendation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                targetLat: targetLat,
                targetLon: targetLon,
                userLat: 38.7223,   // Lizbon merkez
                userLon: -9.1393
            })
        });

        if (!response.ok) {
            alert("Öneri alınamadı");
            return;
        }

        const data = await response.json();
        renderRecommendations(data);
    }

    // ================================
    // 5️⃣ SOL PANELİ DOLDUR
    // ================================
    function renderRecommendations(data) {

        const panel = document.getElementById('recommendationList');
        panel.innerHTML = '';

        data.all_parkings.forEach(p => {
            panel.innerHTML += `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <b>${p.park_id}</b><br/>
                        Doluluk: ${Math.round(p.occupancy_ratio * 100)}%<br/>
                        Yürüme: ${p.walk_min} dk
                    </div>
                </div>
            `;
        });

        renderRecommendationMarkers(data);
    }

    // ================================
    // 6️⃣ HARİTADA ÖNERİ MARKERLARI
    // ================================
    function renderRecommendationMarkers(data) {

        // Eski markerları sil
        recommendationMarkers.forEach(m => map.removeLayer(m));
        recommendationMarkers = [];

        // Tüm önerilenler (mavi)
        data.all_parkings.forEach(p => {
            const marker = L.circleMarker([p.latitude, p.longitude], {
                radius: 7,
                color: '#0d6efd',
                fillOpacity: 0.8
            }).addTo(map);

            recommendationMarkers.push(marker);
        });

        // ⭐ En iyi öneri (kırmızı)
        const best = data.recommended_parking;
        const bestMarker = L.marker([best.latitude, best.longitude])
            .addTo(map)
            .bindPopup("⭐ En iyi otopark")
            .openPopup();

        recommendationMarkers.push(bestMarker);
    }

</script>
}
